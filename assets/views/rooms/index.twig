{% extends 'ridi.twig' %}

{% block head %}
  <!--
  dhtmlx 는 암묵적인 사용이 많아 다루기 까다롭다...
  가능하다면 다른것 사용할것...ㅠ
  -->
  {{ parent() }}
  <script type="text/javascript" src="/static/lib/dhtmlxScheduler/dhtmlxscheduler.js"></script>
  <script type="text/javascript" src="/static/lib/dhtmlxScheduler/ext/dhtmlxscheduler_units.js"></script>
  <link rel="stylesheet" type="text/css" href="/static/lib/dhtmlxScheduler/dhtmlxscheduler_flat.css"/>

  <style type="text/css" media="screen">
    .dhx_scale_holder_now.weekday, .dhx_scale_holder.weekday {
      /*background-image: url(/static/lib/dhtmlxScheduler/common/week_bg.png);*/
    }

    .dhx_cal_event_cont_selected {
      background-color: #9cc1db;
      color: white;
    }

    .dhx_scale_hour_main {
      float: left;
      text-align: right;
      font-size: 16px;
      font-weight: bold;
    }

    .dhx_scale_hour_minute_cont {
      float: left;
      position: relative;
      text-align: right;
    }

    .dhx_scale_hour_minute_top, .dhx_scale_hour_minute_bottom {
      font-size: 10px;
      padding-right: 5px;
    }

    .dhx_scale_hour_sep {
      position: absolute;
      height: 1px;
      background-color: #8C929A;
      right: 0;
      top: 20px;
      width: 20px;
    }

    .dhx_cal_event.group div{
      background-color: #5cb85c !important;
    }

    @media (max-width: 600px) {
      .dhx_cal_today_button { right: 20px; }
      .dhx_cal_prev_button { right: 5px; }
      .dhx_cal_next_button { right: -20px; }
    }
  </style>

  <script type="text/javascript" charset="utf-8">
    'use strict';
    function init($) {
      var event_handler = new function () {
      var event_handler = this;
      var edit_selected_date_from, edit_selected_date_to;
      this.scheduler = window.scheduler;
      this.handler_helper = function (event_type) {
        return function (event_id, event_object) {
          return event_handler.handler(event_type, event_id, event_object);
        };
      };

      this.handler = function (event_type, event_id, event_object) {
        if (this.hasOwnProperty(event_type)) {
          return this[event_type](event_id, event_object);
        } else {
          throw 'not exist handler ' + event_type;
        }
      };
      this.beforeEdit = function (event_id, event) {
        if (event.group) {
          return false;
        }

        if (String(event_id).indexOf('#') >= 0) {
          return false;
        }
        try {
          edit_selected_date_from = new Date(event_handler.scheduler.getEventStartDate(event_id));
          edit_selected_date_to = new Date(event_handler.scheduler.getEventEndDate(event_id));
        } catch (e) {
        }

        return true;
      };

      this.afterEdit = function (event_id) {
        if (this.isDuplicatedEvent(event_id)) {
          alert('이미 예약된 시간입니다');
          event_handler.scheduler.setEventStartDate(event_id, edit_selected_date_from);
          event_handler.scheduler.setEventEndDate(event_id, edit_selected_date_to);
          return false;
        }

        var event_object = scheduler.getEvent(event_id);
        var from = event_handler.scheduler.getEventStartDate(event_id);
        var to = event_handler.scheduler.getEventEndDate(event_id);
        from = from.getFullYear() + '-' + (from.getMonth() + 1) + '-' + from.getDate() + ' ' + from.getHours() + ':' + from.getMinutes();
        to = to.getFullYear() + '-' + (to.getMonth() + 1) + '-' + to.getDate() + ' ' + to.getHours() + ':' + to.getMinutes();

        var postArg = {
          desc: event_handler.scheduler.getEventText(event_id),
          from: from,
          to: to,
          room_id: event_object.room_id
        };

        $.post('/rooms/event/' + event_id, postArg, function (dat) {
            if (dat != '1') {
              alert(dat);
              event_handler.scheduler.setEventStartDate(event_id, edit_selected_date_from);
              event_handler.scheduler.setEventEndDate(event_id, edit_selected_date_to);
            }
          }
        );
        return true;
      };

      this.onEventCreated = function (event_id) {
        try {
          event_handler.scheduler.getEvent(event_id).text = '[예약자] {{ name }}\n[예약내용] ';
          event_handler.scheduler.updateEvent(event_id);
        } catch (e) {
        }
        return true;
      };

      this.isDuplicatedEvent = function (event_id) {
        var event_object = event_handler.scheduler.getEvent(event_id);
        var evs = event_handler.scheduler.getEvents(event_object.start_date, event_object.end_date);

        for (var k in evs) {
          if (!evs.hasOwnProperty(k)) {
            continue;
          }
          if (evs[k].id == event_id) {
            continue;
          }
          if (evs[k].room_id != event_object.room_id) {
            continue;
          }
          return true;
        }
        return false;
      };

      this.onEventAdded = function (event_id, event_object) {
        if (this.isDuplicatedEvent(event_id)) {
          alert('이미 예약된 시간입니다');
          event_handler.scheduler.deleteEvent(event_id);
          return false;
        }

        var from = event_handler.scheduler.getEventStartDate(event_id);
        var to = event_handler.scheduler.getEventEndDate(event_id);
        from = from.getFullYear() + '-' + (from.getMonth() + 1) + '-' + from.getDate() + ' ' + from.getHours() + ':' + from.getMinutes();
        to = to.getFullYear() + '-' + (to.getMonth() + 1) + '-' + to.getDate() + ' ' + to.getHours() + ':' + to.getMinutes();

        $.post('/rooms/event', {
            desc: event_handler.scheduler.getEventText(event_id),
            from: from,
            to: to,
            room_id: event_object.room_id
          }, function (dat) {
            try {
              var new_event_id = parseInt(dat);
              if (isNaN(new_event_id) || new_event_id == 0) {
                alert(dat);
                event_handler.scheduler.deleteEvent(event_id);
              }
              else {
                event_handler.scheduler.changeEventId(event_id, new_event_id);
              }
            }
            catch (e) {
              alert('이벤트 추가가 실패하였습니다');
              event_handler.scheduler.deleteEvent(event_id);
            }
          }
        );
        return true;
      };

      this.onBeforeEventDelete = function (event_id, event) {
        if (event.group) {
          return false;
        }

        $.ajax({
          url: '/rooms/event/' + event_id,
          type: 'DELETE',
        });

        return true;
      };
    };

    scheduler.config.mark_now = true;
    scheduler.config.time_step = 15;
    scheduler.config.first_hour = 10;
    scheduler.config.last_hour = 22;
    scheduler.config.details_on_dblclick = false;
    scheduler.config.mark_now = true;
    scheduler.config.hour_size_px = 88;
    scheduler.config.icons_select = ['icon_edit', 'icon_delete'];

    scheduler.templates.event_class = function(start, end, event) {
      return event.group ? 'group' : '';
    };

    scheduler.templates.event_text = function (start, end, event) {
      if (!event.group) {
        return event.text;
      }

      var daysOfWeekMap = ['일', '월', '화', '수', '목', '금', '토'];
      var daysOfWeek = event.days_of_week.split(',').map(function (day) {
        return daysOfWeekMap[day];
      }).join(',');

      return daysOfWeek + '요일 정기예약' + '<br>' + event.text;
    };

    scheduler.renderEvent = function (container, event) {
      if ((event.end_date - event.start_date)/60000 > 15) {
        return false;
      }

      var container_width = container.style.width;
      var container_height = parseInt(container.style.height, 10)/2;

      var html = '<div class="dhx_event_move dhx_header" style="margin: 0px; padding: 0px; width: ' + container_width + ';"></div>';
      html += '<div class="dhx_event_move dhx_body" style="margin: 0px; padding: 0px; height: ' + container_height + ';">';

      html += '<span class="dhx_title">'
        + scheduler.templates.event_date(event.start_date)
        + ' - ' + scheduler.templates.event_date(event.end_date)
        + '</span>';
      html += '<span style="margin-left: 5px">'
        + scheduler.templates.event_text(event.start_date,event.end_date,event)
        + '</span>';

      html += '</div>';
      html += '<div class="dhx_event_resize dhx_footer" style="width: ' + container_width + '"></div>';
      container.innerHTML = html;
      return true;
    };

    scheduler.attachEvent('onEventCreated', event_handler.handler_helper('onEventCreated'));
    scheduler.attachEvent('onEventAdded', event_handler.handler_helper('onEventAdded'));
    scheduler.attachEvent('onBeforeDrag', event_handler.handler_helper('beforeEdit'));
    scheduler.attachEvent('onDblClick', event_handler.handler_helper('beforeEdit'));
    scheduler.attachEvent('onClick', event_handler.handler_helper('beforeEdit'));
    scheduler.attachEvent('onEventChanged', event_handler.handler_helper('afterEdit'));
    scheduler.attachEvent('onBeforeEventDelete', event_handler.handler_helper('onBeforeEventDelete'));

    scheduler.config.xml_date = '%Y-%m-%d %H:%i';
    scheduler.config.default_date = '%Y/%m/%d %D';
    scheduler.config.day_date = '%m/%d';
    scheduler.config.multi_day = true;
    scheduler.config.show_loading = true;

    scheduler.setLoadMode('day');

    var sections = {{ sections|json_encode()|raw }};

    if (window.innerWidth < 980) {
      $('#js_howto').hide();
      scheduler.createUnitsView({
        name: 'unit_mobile',
        property: 'room_id',
        list: sections,
        size: 1,
        step: 1
      });
      scheduler.init('scheduler_here', null, 'unit_mobile');
    } else {
      scheduler.createUnitsView({
        name: 'unit_pc',
        property: 'room_id',
        list: sections,
      });
      scheduler.init('scheduler_here', null, 'unit_pc');
    }

    var room_ids = sections.map(function (section) {
      return section.key;
    });
    scheduler.load('/rooms/event?room_ids=' + room_ids.join(','), 'json');
  }

  require(['jquery'], function ($) {
    $(init($));
    $('#js_howto_button').click(function () {
      $('#js_howto_detail').toggle();
    });
  });
  </script>
{% endblock %}

{% block body %}
  <div>
    <div>
      {% if notice is defined %}
        <div style="color: #888888">
          {{ notice|raw }}
        </div>
      {% endif %}

      {% if warning is defined %}
        <div style="text-decoration:underline;font-weight:bold;font-size:14px;">
          {{ warning|raw }}
        </div>
      {% endif %}

      {% if description is defined %}
        <div style="position:absolute;right:15px;top:80px;z-index: 1000;">
          <div style="float:right;text-align: right" id="js_howto">
            <button id="js_howto_button" class="btn btn-default">사용법</button>
            <pre id="js_howto_detail" style="display: none;text-align: left;">{{ description }}</pre>
          </div>
        </div>
      {% endif %}
    </div>
    <div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%; overflow: visible'>
      <div class="dhx_cal_navline">
        <div class="dhx_cal_prev_button"></div>
        <div class="dhx_cal_next_button"></div>
        <div class="dhx_cal_today_button"></div>
        <div class="dhx_cal_date"></div>
      </div>

      <div class="dhx_cal_header">
      </div>
      <div class="dhx_cal_data"></div>
    </div>
  </div>
{% endblock %}
